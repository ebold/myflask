// source: https://gist.github.com/umidjons/9614157
function sortProperties(obj, ascending)
{
    // convert object into array
    var sortable=[];
    for(var key in obj)
        if(obj.hasOwnProperty(key))
            sortable.push([key, obj[key]]); // each item is an array in format [key, value]

    // sort items by value
    sortable.sort(function(a, b)
    {
        if (ascending)
            return a[1]-b[1]; // compare numbers
        else
            return b[1]-a[1];
    });
    return sortable; // array in format [ [ key1, val1 ], [ key2, val2 ], ... ]
}

//https://getbutterfly.com/generate-html-list-from-javascript-array/
function makeSortedUL(results, candidates) {
    // Show results in un-ordered list sorted with the poll results (highest score on top)

    // make a list container element for results
    let resultsContainer = document.createElement('div'),
    // make the list element that contains votes per constituency
    constituencyList = document.createElement('ul');

    // add list container to the page
    document.getElementsByTagName('body')[0].appendChild(resultsContainer);
    resultsContainer.appendChild(constituencyList)

    // for each constituency create votes sub-list that has sorted votes
    for (var e in candidates) {
        // create an list item
        var constituencyListItem = document.createElement('li')

        // set its contents
        constituencyListItem.innerHTML = e + "-р тойрог, " + candidates[e].province + ", " + candidates[e].mandates + " мандат"

        // create votes sub-list in the constituency list
        constituencyListVotes = document.createElement('ul');
 
        // sort the constituency votes
        var sortedVotes=sortProperties(results.votes[e], false);

        // list votes in votes sub-list
        for (var i = 0; i < sortedVotes.length; i++) {
            v = document.createElement('li');

            id = sortedVotes[i][0]
            candidate = candidates[e].candidates[id]
            v.innerHTML = sortedVotes[i][1] + " - " + candidate.name + ", " + candidate.party;

            constituencyListVotes.appendChild(v);
        }
        // add votes sub-list to constituency list
        constituencyListItem.appendChild(constituencyListVotes)

        // add item to list
        constituencyList.appendChild(constituencyListItem);
    }
}

/**
 *
 * @param {object} obj      - object to sort, eg., result_2020.json
 * @param {string} sortedBy - sort property, eg., 'v' in result_2020.json
 * @param {bool} ascending  - sorting order
 * @returns {Array} array in format [ [key1, val1], [key2, val2], ... ]
 *
 * Derived from sortProperties()
 *
 */
function sortVotes(obj, sortedBy, ascending)
{
    sortedBy = sortedBy || 1; // first key, by default

    // convert object into array
    var sortable=[];
    for(var key in obj)
        if(obj.hasOwnProperty(key))
            sortable.push([key, obj[key]]); // each item is an array in format [key, value]

    sortable.sort(function(a, b)
    {
        if (ascending)
            return a[1][sortedBy]-b[1][sortedBy]; // compare values
        else
            return b[1][sortedBy]-a[1][sortedBy];
    });
    return sortable; // array in format [ [ key1, val1 ], [ key2, val2 ], ... ]
}

/**
 *
 * @param {object} results    - object with vote result, eg., 'result_2020.json'
 * @param {object} candidates - object with candidates, eg., 'list.json'
 *
 * Derived from makeSortedUL()
 */
function makeSortedResult(results, candidates) {
    // Show results in un-ordered list sorted with the poll results (highest score on top)

    // make a list container element for results
    let resultsContainer = document.createElement('div'),
    // make the list element that contains votes per constituency
    constituencyList = document.createElement('ul');

    // add list container to the page
    document.getElementsByTagName('body')[0].appendChild(resultsContainer);
    resultsContainer.appendChild(constituencyList)

    // for each constituency create votes sub-list that has sorted votes
    for (var e in candidates) {
        // create an list item
        var constituencyListItem = document.createElement('li')

        // set its contents
        constituencyListItem.innerHTML = e + "-р тойрог, " + candidates[e].province + ", " + candidates[e].mandates + " мандат"

        // create votes sub-list in the constituency list
        constituencyListVotes = document.createElement('ol');

        // sort the constituency votes (eg., sort according to votes indicated by 'v' in result_2020.json)
        var sortedVotes=sortVotes(results.votes[e], 'v', false);

        // list votes in votes sub-list
        for (var i = 0; i < sortedVotes.length; i++) {
            v = document.createElement('li');

            id = sortedVotes[i][0]
            candidate = candidates[e].candidates[id]

            // text fields: votes (percentage) - name, party
            text = sortedVotes[i][1]['v'] + " (" + sortedVotes[i][1]['p'] + "%) - " + candidate.name + ", " + candidate.party;

            if (i < candidates[e].mandates)
                v.innerHTML = "<b>" + text + "</b>";
            else
                v.innerHTML = text;

            constituencyListVotes.appendChild(v);
        }
        // add votes sub-list to constituency list
        constituencyListItem.appendChild(constituencyListVotes)

        // add item to list
        constituencyList.appendChild(constituencyListItem);
    }
}
